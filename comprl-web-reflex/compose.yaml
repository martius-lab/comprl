# Base compose file production deployment of reflex app with Caddy webserver
# providing TLS termination and reverse proxying.
#
# See `compose.prod.yaml` for more robust and performant deployment option.
#
# During build and run, set environment DOMAIN pointing
# to publicly accessible domain where app will be hosted
services:
  app:
    environment:
      # this refers to the path inside the container (see binding added below)
      COMPRL_CONFIG_PATH: /config.toml
    build:
      context: ..
      dockerfile: ./comprl-web-reflex/Dockerfile
    volumes:
      - type: bind
        source: ${COMPRL_CONFIG_PATH:-../comprl-hockey-game/config-docker.toml}
        target: /config.toml
        read_only: true
        bind:
          create_host_path: false
      - type: bind
        source: ${COMPRL_DATA_PATH:-../comprl-hockey-game}
        target: /comprl-data
        bind:
          create_host_path: true
    restart: always

  webserver:
    environment:
      DOMAIN: ${DOMAIN:-localhost}
      # Those data and config folders are already set in the container by default but
      # better let's be explicit, in case the defaults change.
      XDG_DATA_HOME: /data
      XDG_CONFIG_HOME: /config
    ports:
      - 443:443
      - 80:80 # For acme-challenge via HTTP.
    build:
      context: .
      dockerfile: Caddy.Dockerfile
      additional_contexts:
        app_image: "service:app"
    volumes:
      - caddy-data:/data/caddy
      - caddy-config:/config/caddy
    restart: always
    depends_on:
      - app

volumes:
  # TLS keys and certificates
  caddy-data:
  caddy-config:
